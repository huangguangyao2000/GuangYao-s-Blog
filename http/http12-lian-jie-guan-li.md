# HTTP-12-连接管理

## TCP连接

### 可靠数据管道

TCP为HTTP提供了一条可靠的比特传输管道。从TCP连接一端填入的字节会从另一端以原有的顺序、正确地传送出来。

### TCP流是分段的、由IP分组传送

TCP数据是通过名为**IP分组**的小数据块来发送的。

HTTP传送报文时，会以**流**的形式将报文数据的内容通过打开的TCP连接按序传输。TCP收到数据流后，会**将数据流砍成被视为段的小数据块**，并将**段封装在IP分组**中，通过因特网传输。

每个IP分组中包括：

* 一个IP分组首部
* 一个TCP段首部
* 一个TCP数据块

  \*\*\*\*

**保持TCP连接正确运行**

TCP通过**端口号**来保持所有连接正确运行。TCP连接是通过4个值来识别的：

`<源IP地址、源端口号、目的IP地址、目的端口号>`

这四个值**唯一**地定义了一条连接。

### 用TCP套接字编程

## TCP性能

HTTP位于TCP上层，所以HTTP事务的性能在很大程度上**取决于底层TCP通道**的性能

### HTTP事务的时延

与建立TCP连接以及传输请求和响应报文的时间相比，事务处理时间可能是很短的。可见HTTP时延就是由**TCP网络时延**构成的。

时延主要有一下几种主要原因： 1. 根据URI确定Web服务器的**IP地址和端口号**，若**没有**IP地址缓存，则通过**DNS解析**系统将URI中的主机名转换为IO地址可能要花费数十秒的事件。 2. 客户端会向服务器发送一条**TCP连接请求**，并等待服务器回送一个请求**接受应答**。每个新的TCP连接都会有**连接建立时延**。 3. 一旦**建立了连接**，客户端就会通过新建立的TCP管道来发送HTTP请求。数据到达时，Web服务器会从TCP连接中读取请求报文，并处理请求。 4. 然后Web服务器回送HTTP响应。

### 性能聚焦区域

#### TCP连接的握手时延

耗时严重的连接只用来传送少量数据，严重限制了HTTP的性能。

#### 延迟确认

因特网无法确保可靠的分组传输，TCP实现了自己的确认机制来确保数据成功传输。

每个TCP段都有一个**序列号和数据完整性校验和**。每个段的接收者收到**完好的段**时，都会向发送者**回送小的确认分组**。若发送者**没有在指定的窗口时间内收到确认信息**，则发送者认为**分组已被破坏或损毁**，并重发数据。

因确认报文很小，TCP将**返回的确认信息与输出的数据分组结合**在一起，更有效的利用网络。很多TCP栈实现了“**延迟确认**”算法，会在一个特定的**窗口时间内**将输出确认放在**缓冲区**中，以等待寻找**能够捎带它的数据分组**。若没有则单独发送。

#### TCP慢启动

性能还取决于TCP连接的使用期，因TCP具有慢启动机制。**TCP会随着时间调谐，起初限制连接最大速度，若数据成功传输，随着时间推移会提高传输的速度。**

#### Nagle算法和TCP\_NODELAY

Nagle算法试图在发送一个分组前，将大量TCP数据绑定在一起，以提高网络效率。该算法鼓励发送**全尺寸的段**。只有所有其他分组都被确认后，Nagle算法才允许发送非全尺寸的分组。

但会引发问题:

* 小的HTTP报文可能无法填满一个分组。
* 与延迟确认之间的交互存在问题。

设置**TCP\_NODELAY可禁用Nagle算法**。

